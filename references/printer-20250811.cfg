# This file contains pin mappings for the Creality "v4.2.7" board. To
# use this config, during "make menuconfig" select the STM32F103 with
# a "28KiB bootloader" and serial (on USART1 PA10/PA9) communication.

# If you prefer a direct serial connection, in "make menuconfig"
# select "Enable extra low-level configuration options" and select
# serial (on USART3 PB11/PB10), which is broken out on the 10 pin IDC
# cable used for the LCD module as follows:
# 3: Tx, 4: Rx, 9: GND, 10: VCC

# Flash this firmware by copying "out/klipper.bin" to a SD card and
# turning on the printer with the card inserted. The firmware
# filename must end in ".bin" and must not match the last filename
# that was flashed.

# See docs/Config_Reference.md for a description of parameters.

[stepper_x]
step_pin: PB9
dir_pin: PC2
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA5
position_endstop: 0
position_max: 235
homing_speed: 50

[stepper_y]
step_pin: PB7
dir_pin: PB8
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA6
position_endstop: 0
position_max: 235
homing_speed: 50

[stepper_z]
step_pin: PB5
dir_pin: !PB6
enable_pin: !PC3
microsteps: 16
rotation_distance: 8
#position_endstop: 0.0                     # disable to use BLTouch
#endstop_pin: ^PA7                         # disable to use BLTouch
endstop_pin: probe:z_virtual_endstop    # enable to use BLTouch
position_min: -5                        # enable to use BLTouch
position_max: 250

[safe_z_home]                         # enable for BLTouch
home_xy_position: 117.5,117.5
speed: 100
z_hop: 10
z_hop_speed: 5

[bltouch]                             # enable for BLTouch - fast-mode
sensor_pin: ^PB1
control_pin: PB0
pin_up_touch_mode_reports_triggered: True
probe_with_touch_mode: True
x_offset: -44                         # modify as needed for bltouch location
y_offset: -6                          # modify as needed for bltouch location
#z_offset: 0.0                         # modify as needed for bltouch or run PROBE_CALIBRATE
speed: 10
samples: 3
sample_retract_dist: 5.0              # Can be set lower, example 2.5 depending on height of bltouch from bed
lift_speed: 40
samples_tolerance_retries: 3
speed: 10
samples: 2

[bed_mesh]
speed: 80
horizontal_move_z: 5
mesh_min: 15,15
mesh_max: 188,191
probe_count: 5,5
algorithm: bicubic

# # manual Bed adjustment via BED_SCREWS_ADJUST
# [bed_screws]
# screw1: 72.5, 41.5
# screw1_name: front left screw
# screw2: 198.5,35.5
# screw2_name: front right screw
# screw3: 198.5,205.5
# screw3_name: rear right screw
# screw4: 28.5,205.5
# screw4_name: rear left screw
# horizontal_move_z: 10
# speed: 50

[screws_tilt_adjust]
screw1: 72.5, 41.5
screw1_name: front left screw
screw2: 198.5,41.5
screw2_name: front right screw
screw3: 198.5,212.5
screw3_name: rear right screw
screw4: 72.5,212.5
screw4_name: rear left screw
horizontal_move_z: 10
speed: 50
screw_thread: CW-M4

[input_shaper]
shaper_freq_x: 100
shaper_freq_y: 100
shaper_type: mzv

[gcode_macro G29]
gcode:
    G28
    BED_MESH_CALIBRATE
    G0 X0 Y0 Z10 F6000
    BED_MESH_PROFILE save=default
    SAVE_CONFIG


[extruder]
max_extrude_only_distance: 100.0
step_pin: PB3
dir_pin: PB4
enable_pin: !PC3
microsteps: 16
rotation_distance: 33.500
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
control: pid
pid_Kp: 21.527
pid_Ki: 1.063
pid_Kd: 108.982
min_temp: 0
max_temp: 250
pressure_advance: .1

[heater_bed]
heater_pin: PA2
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
control: pid
pid_Kp: 54.027
pid_Ki: 0.770
pid_Kd: 948.182
min_temp: 0
max_temp: 130

[fan]
pin: PA0

[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command

[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 3000
max_accel_to_decel: 3000
max_z_velocity: 5
max_z_accel: 100

[display]
lcd_type: st7920
cs_pin: PB12
sclk_pin: PB13
sid_pin: PB15
encoder_pins: ^PB14, ^PB10
click_pin: ^!PB2

[board_pins]
aliases:
  EXP1_1=PC6,EXP1_3=PB10,EXP1_5=PB14,EXP1_7=PB12,EXP1_9=<GND>**,**
  EXP1_2=PB2,EXP1_4=PB11,EXP1_6=PB13,EXP1_8=PB15,EXP1_10=<5V>**,**
  PROBE_IN=PB0,PROBE_OUT=PB1,FIL_RUNOUT=PC6

# Enable object exclusion
[exclude_object]

# Enable arcs support
[gcode_arcs]
resolution: 0.1

[gcode_macro PRINT_START]
description: Ender 3 (v4.2.7) + BLTouch + OrcaSlicer (M82) â€“ hot home, load mesh, prime inside mesh
# Usage from slicer:
#   M82
#   G92 E0
#   PRINT_START EXTRUDER=[first_layer_temperature] BED=[first_layer_bed_temperature]
gcode:
    {% set extruder_temp = params.EXTRUDER|float %}
    {% set bed_temp      = params.BED|float %}

    # --- Modes / safety ---
    G90                 ; absolute XYZ
    M82                 ; absolute extrusion (OrcaSlicer default)
    M107                ; fan off
    G21                 ; mm units

    # --- Heat order: bed first (for correct Z), then home/probe, then nozzle ---
    M140 S{bed_temp}                    ; start bed heating (non-blocking)
    M104 S{extruder_temp * 0.6}         ; gentle preheat to reduce ooze
    M190 S{bed_temp}                    ; ***wait for bed*** (heat-soak)

    G28                                 ; home at temp (uses [safe_z_home])

    BED_MESH_PROFILE LOAD=default       ; use your saved mesh

    M104 S{extruder_temp}               ; bring nozzle to final
    M109 S{extruder_temp}               ; ***wait for nozzle***

    # --- Prime line INSIDE probed area (your mesh is 15,15 -> 188,191) ---
    {% set z_first = 0.2 %}
    {% set x_start = 20 %}
    {% set y_start = 20 %}
    {% set y_end   = 190 %}

    G92 E0
    G1 Z{z_first + 2} F600
    G1 X{x_start} Y{y_start} F6000
    G1 Z{z_first} F600
    G1 E5 F300                          ; small pre-spit
    G1 Y{y_end}   E25 F1000             ; long straight prime
    G1 X{ x_start + 2 } F6000           ; small shift
    G1 Y{ y_start } E5 F1000            ; second short pass (optional)
    G1 E-0.8 F3600                      ; tidy retract
    G1 Z{z_first + 2} F600
    G92 E0

    ; Hand control back to the slicer at first-layer height/temp
    ; (skirt/brim/first move comes next)

[gcode_macro PRINT_END]
gcode:
    # Disable heaters (hotend and bed) for safety and to cool down.
    M104 S0 ; Turn off hotend
    M140 S0 ; Turn off bed

    # Move to absolute positioning mode.
    G90

    # Retract filament to prevent oozing and stringing while moving.
    # Adjust the E value based on your extruder and hotend. 10mm is a common value.
    G92 E0 ; Reset extruder position
    G1 E-10 F1800 ; Retract 10mm of filament at 30mm/s (1800mm/min)

    # Define a safe Z height to move to after the print.
    # This should be high enough to clear any finished prints or clips.
    # Adjust 'Z_SAFE_HEIGHT' to be appropriate for your printer.
    {% set Z_SAFE_HEIGHT = 20 %} # Lift Z by 20mm, adjust as needed

    # Get current Z position
    {% set current_z = printer.toolhead.position.z %}

    # Move Z axis up to the safe height.
    # Use max_z from printer.toolhead.axis_maximum.z to ensure it doesn't go too high.
    # This prevents the print head from crashing if current_z + Z_SAFE_HEIGHT is too high.
    G0 Z{([current_z + Z_SAFE_HEIGHT, printer.toolhead.axis_maximum.z]|min)} F600

    # Define the Y position for the bed to move forward ("eject").
    # This should be a value that brings the print bed forward enough for easy removal.
    # Adjust 'Y_EJECT_POS' based on your printer's bed size.
    # For a typical Cartesian printer, 200-220mm might bring the bed far forward.
    # Ensure this position is within your printer's Y maximum range.
    {% set Y_EJECT_POS = printer.toolhead.axis_maximum.y - 10 %} # Move bed almost all the way out, 10mm from max Y

    # Move print bed forward (Y-axis) to "eject" the print.
    G0 Y{Y_EJECT_POS} F3000

    # Optional: Move print head to a specific park position on X-axis (e.g., far right).
    # This helps clear the view and access to the print.
    # {% set X_PARK_POS = printer.toolhead.axis_maximum.x - 10 %} # Move X to almost max X
    # G0 X{X_PARK_POS} F3000

    # Disable stepper motors AFTER all movements are complete.
    # This allows you to move the print head and bed by hand after the macro finishes.
    M84 E0 ; Disable extruder stepper immediately
    M84     ; Disable all other steppers after a short delay (usually 10 seconds by default in Klipper)


[include mainsail.cfg]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [bltouch]
#*# z_offset = 0.820
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.106250, -0.150000, -0.115000, -0.070000, 0.037500
#*# 	  0.061250, 0.016250, 0.020000, 0.036250, 0.121250
#*# 	  0.077500, 0.016250, 0.018750, 0.036250, 0.108750
#*# 	  0.061250, 0.037500, 0.057500, 0.082500, 0.160000
#*# 	  0.056250, -0.011250, -0.016250, -0.003750, 0.063750
#*# x_count = 5
#*# y_count = 5
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 15.0
#*# max_x = 188.0
#*# min_y = 15.0
#*# max_y = 191.0
